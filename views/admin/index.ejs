<%- include('../partials/head', { pageTitle, hotelName, csrfToken, darkMode }) %>
<script defer src="/js/admin-dining-console.js"></script>
<%- include('../partials/nav') %>
<%- include('../partials/alerts') %>

<section class="admin" data-animate="fade-up">
  <h1>Control deck</h1>
  <p>Monitor inventory, track bookings, and respond to guest signals across <%= hotelName %>.</p>

  <% const roleLabels = { GLOBAL_ADMIN: 'Global Admin', SUPER_ADMIN: 'Super Admin', ADMIN: 'Admin', EMPLOYEE: 'Employee' }; %>
  <% const roleDescriptions = {
    GLOBAL_ADMIN: 'Architects the Skyhaven ecosystem and steers every console.',
    SUPER_ADMIN: 'Oversees regional consoles and mentors Admin teams.',
    ADMIN: 'Runs day-to-day guest operations and supports on-site teams.',
    EMPLOYEE: 'Provides world-class service across the hotel.'
  }; %>
  <% const actorRoleLabel = roleLabels[adminAccess.actorRole] || 'Admin'; %>
  <% const allowedRoleLabels = (adminAccess.allowedSubAdminRoles || []).map(function(role) { return roleLabels[role]; }); %>
  <% let delegationIntro; %>
  <% if (adminAccess.actorRole === 'GLOBAL_ADMIN') { %>
    <% delegationIntro = 'You can elevate trusted leaders into Super Admin or Admin roles and fine-tune their privileges.'; %>
  <% } else if (adminAccess.actorRole === 'SUPER_ADMIN') { %>
    <% delegationIntro = 'You can create Admin accounts and tailor their operational privileges. Reach out to the Global Admin for Super Admin promotions.'; %>
  <% } else { %>
    <% delegationIntro = 'You can orchestrate bookings, amenities, and inquiries. Coordinate with a Super Admin if your team needs additional admin accounts.'; %>
  <% } %>

  <section class="admin-panel admin-access-panel">
    <div class="admin-access-header">
      <div>
        <h2>Administrative hierarchy</h2>
        <p class="admin-access-subtitle">Delegate control of Skyhaven's systems with precision.</p>
      </div>
      <span class="role-badge role-badge--<%= String(adminAccess.actorRole || '').toLowerCase() %>">
        <span class="role-badge__label"><%= actorRoleLabel %></span>
      </span>
    </div>
    <p class="admin-access-copy"><%= delegationIntro %></p>
    <% if (allowedRoleLabels.length) { %>
      <p class="admin-access-hint">
        Delegation options: <strong><%= allowedRoleLabels.join(', ') %></strong>
      </p>
      <div
        class="subadmin-wizard"
        data-subadmin-wizard
        data-config='<%- JSON.stringify({ allowedSubAdminRoles: adminAccess.allowedSubAdminRoles, actorRole: adminAccess.actorRole }) %>'
      >
        <div class="subadmin-wizard__stage" data-stage="select">
          <h3>Choose an access tier</h3>
          <p class="muted">Select the level of control you want to grant.</p>
          <div class="subadmin-wizard__roles">
            <% adminAccess.allowedSubAdminRoles.forEach(function(role) { %>
              <button type="button" class="subadmin-role" data-role-option data-role="<%= role %>">
                <span class="subadmin-role__label"><%= roleLabels[role] %></span>
                <span class="subadmin-role__detail"><%= roleDescriptions[role] || 'Provides operational coverage across the hotel.' %></span>
              </button>
            <% }) %>
          </div>
          <div class="subadmin-wizard__actions">
            <button type="button" class="pill-link primary" data-action="advance" disabled>Continue</button>
          </div>
        </div>
        <div class="subadmin-wizard__stage" data-stage="details" hidden>
          <h3>Set up a new <span data-selected-role-label>Admin</span></h3>
          <form data-subadmin-form novalidate>
            <input type="hidden" name="role" data-role-input />
            <div class="subadmin-form-grid">
              <label class="subadmin-field">
                <span class="subadmin-field__label">Full name</span>
                <input type="text" name="name" required autocomplete="name" placeholder="Nova Patel" />
              </label>
              <label class="subadmin-field">
                <span class="subadmin-field__label">Email</span>
                <input type="email" name="email" required autocomplete="email" placeholder="nova@skyhaven.test" />
              </label>
              <label class="subadmin-field">
                <span class="subadmin-field__label">Temporary password</span>
                <input type="password" name="password" required autocomplete="new-password" minlength="8" placeholder="Min. 8 characters" />
                <small class="subadmin-field__hint">Share securely with the new admin and encourage a reset on first login.</small>
              </label>
              <label class="subadmin-field">
                <span class="subadmin-field__label">Department (optional)</span>
                <input type="text" name="department" autocomplete="organization" placeholder="Front Desk" />
              </label>
            </div>
            <p class="subadmin-feedback" data-subadmin-feedback aria-live="polite"></p>
            <div class="subadmin-wizard__actions">
              <button type="button" class="pill-link secondary" data-action="back">Back</button>
              <button type="submit" class="pill-link primary" data-action="submit">
                Create <span data-selected-role-label>Admin</span>
              </button>
            </div>
          </form>
        </div>
        <div class="subadmin-wizard__stage" data-stage="result" hidden>
          <div class="subadmin-success">
            <h3>Delegation complete</h3>
            <p>
              <strong data-result-name></strong>
              now has <span data-result-role></span> privileges.
            </p>
          </div>
          <div class="subadmin-wizard__actions">
            <button type="button" class="pill-link secondary" data-action="finish-wizard">Close</button>
            <button type="button" class="pill-link primary" data-action="create-another">Create another</button>
          </div>
        </div>
      </div>
    <% } else { %>
      <div class="admin-access-note">
        <p class="muted">
          Delegating new admin accounts requires Super Admin privileges. Coordinate with your Super Admin team if you need additional coverage.
        </p>
      </div>
    <% } %>
  </section>

  <% if (adminAccess.allowedSubAdminRoles && adminAccess.allowedSubAdminRoles.length) { %>
    <section class="admin-panel subadmin-roster-panel" data-subadmin-roster data-empty-text="No delegated administrators yet.">
      <div class="subadmin-roster__header">
        <div>
          <h2>Delegated administrators</h2>
          <p class="muted">Keep track of the teammates you've elevated.</p>
        </div>
        <button type="button" class="pill-link secondary" data-roster-refresh>Refresh</button>
      </div>
      <p class="subadmin-roster__feedback" data-roster-feedback aria-live="polite"></p>
      <div class="panel-scroll">
        <table class="admin-table subadmin-table">
          <thead>
            <tr>
              <th>Administrator</th>
              <th>Role</th>
              <th>Department</th>
              <th>Status</th>
              <th>Privileges</th>
            </tr>
          </thead>
          <tbody data-roster-body>
            <tr data-roster-loading>
              <td colspan="5">Loading delegated administrators…</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  <% } %>

  <div class="admin-metrics">
    <% metrics.forEach(function(metric) { %>
      <article class="metric-card">
        <p class="metric-label"><%= metric.label %></p>
        <p class="metric-value"><%= metric.value %></p>
        <p class="metric-detail"><%= metric.detail %></p>
      </article>
    <% }) %>
  </div>

  <div class="admin-grid">
    <section class="admin-panel">
      <h2>Room availability</h2>
      <div class="panel-scroll">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Suite</th>
              <th>Capacity</th>
              <th>Availability</th>
              <th>Adjust</th>
            </tr>
          </thead>
          <tbody>
            <% rooms.forEach(function(room) { %>
              <tr class="<%= room.availability <= 3 ? 'is-low' : '' %>">
                <td>
                  <strong><%= room.name %></strong>
                  <p class="muted">View: <%= room.view || 'Skyhaven vista' %></p>
                </td>
                <td><%= room.capacity %></td>
                <td>
                  <span class="inventory-pill"><%= room.availability %></span>
                </td>
                <td>
                  <form action="/admin/rooms/<%= room.id %>" method="post" class="inline-form">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                    <label class="sr-only" for="room-<%= room.id %>-availability">Availability</label>
                    <input
                      id="room-<%= room.id %>-availability"
                      type="number"
                      name="availability"
                      min="0"
                      max="50"
                      value="<%= room.availability %>"
                    />
                    <button type="submit" class="pill-link">Update</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <% if (lowInventoryRooms.length) { %>
        <div class="admin-hint">
          <strong>Low inventory alert:</strong>
          <ul class="chip-list">
            <% lowInventoryRooms.forEach(function(room) { %>
              <li><%= room.name %> (<%= room.availability %>)</li>
            <% }) %>
          </ul>
        </div>
      <% } else { %>
        <p class="admin-hint subtle">All suites are comfortably stocked.</p>
      <% } %>
    </section>

    <section class="admin-panel">
      <h2>Bookings &amp; payments</h2>
      <div class="panel-scroll">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Guest</th>
              <th>Room</th>
              <th>Stay</th>
              <th>Status</th>
              <th>Financial</th>
              <th>Manage</th>
            </tr>
          </thead>
          <tbody>
            <% bookings.forEach(function(booking) { %>
              <tr>
                <td>
                  <div class="stacked">
                    <strong><%= booking.guestName || booking.userId %></strong>
                    <% if (booking.guestEmail) { %>
                      <span class="muted"><%= booking.guestEmail %></span>
                    <% } %>
                  </div>
                </td>
                <td>
                  <div class="stacked">
                    <strong><%= booking.roomName %></strong>
                    <span class="muted">Lead: <%= booking.leadTime %>d</span>
                  </div>
                </td>
                <td>
                  <div class="stacked">
                    <span><%= booking.checkInLabel %> → <%= booking.checkOutLabel %></span>
                    <span class="muted"><%= booking.nights %> night<%= booking.nights === 1 ? '' : 's' %></span>
                  </div>
                </td>
                <td>
                  <span class="status-chip status-<%= booking.status.toLowerCase() %>"><%= booking.status %></span>
                </td>
                <td>
                  <div class="stacked">
                    <strong>$<%= booking.total.toFixed(2) %></strong>
                    <% if (booking.payment) { %>
                      <span class="muted"><%= booking.payment.status %> • ****<%= booking.payment.last4 %></span>
                    <% } else { %>
                      <span class="muted">No payment on file</span>
                    <% } %>
                  </div>
                </td>
                <td>
                  <div class="stacked">
                    <form action="/admin/bookings/<%= booking.id %>/status" method="post" class="inline-form">
                      <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                      <label class="sr-only" for="booking-<%= booking.id %>-status">Status</label>
                      <select id="booking-<%= booking.id %>-status" name="status">
                        <% bookingStatuses.forEach(function(status) { %>
                          <option value="<%= status %>" <%= booking.status === status ? 'selected' : '' %>><%= status %></option>
                        <% }) %>
                      </select>
                      <button type="submit" class="pill-link secondary">Apply</button>
                    </form>
                    <% if (booking.payment && booking.payment.status === 'captured') { %>
                      <form action="/admin/bookings/<%= booking.id %>/refund" method="post" class="inline-form">
                        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                        <button type="submit" class="pill-link danger">Refund</button>
                      </form>
                    <% } %>
                  </div>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
      <div class="status-breakdown">
        <h3>Status distribution</h3>
        <ul class="chip-list">
          <% statusBreakdown.forEach(function(item) { %>
            <li>
              <span class="status-chip status-<%= item.status.toLowerCase() %>"><%= item.status %></span>
              <strong><%= item.count %></strong>
            </li>
          <% }) %>
        </ul>
      </div>
    </section>

    <section class="admin-panel">
      <h2>Operations radar</h2>
      <div class="split-grid">
        <div>
          <h3>Arrivals (7d)</h3>
          <ul class="timeline-list">
            <% if (!upcomingCheckIns.length) { %>
              <li class="timeline-empty">No arrivals on the horizon.</li>
            <% } %>
            <% upcomingCheckIns.forEach(function(booking) { %>
              <li>
                <div class="timeline-info">
                  <strong><%= booking.guestName || booking.userId %></strong>
                  <span class="muted"><%= booking.windowLabel %></span>
                </div>
                <span class="timeline-meta">in <%= booking.daysUntil %>d</span>
              </li>
            <% }) %>
          </ul>
        </div>
        <div>
          <h3>Departures (7d)</h3>
          <ul class="timeline-list">
            <% if (!upcomingCheckOuts.length) { %>
              <li class="timeline-empty">No departures scheduled.</li>
            <% } %>
            <% upcomingCheckOuts.forEach(function(booking) { %>
              <li>
                <div class="timeline-info">
                  <strong><%= booking.guestName || booking.userId %></strong>
                  <span class="muted"><%= booking.windowLabel %></span>
                </div>
                <span class="timeline-meta">in <%= booking.daysUntil %>d</span>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
    </section>

    <section class="admin-panel">
      <h2>Amenity reservations</h2>
      <div class="panel-scroll">
        <table class="admin-table">
          <thead>
            <tr>
              <th>Amenity</th>
              <th>Guest</th>
              <th>Window</th>
              <th>Status</th>
              <th>Manage</th>
            </tr>
          </thead>
          <tbody>
            <% if (!amenityReservations.length) { %>
              <tr>
                <td colspan="5" class="muted">No reservations logged yet.</td>
              </tr>
            <% } %>
            <% amenityReservations.forEach(function(reservation) { %>
              <tr>
                <td>
                  <div class="stacked">
                    <strong><%= reservation.amenityName %></strong>
                    <span class="muted"><%= reservation.durationLabel %> • <%= reservation.amenitySlug %></span>
                  </div>
                </td>
                <td>
                  <div class="stacked">
                    <strong><%= reservation.guestName %></strong>
                    <span class="muted"><%= reservation.guestEmail %></span>
                  </div>
                </td>
                <td>
                  <div class="stacked">
                    <span><%= reservation.startLabel %></span>
                    <span class="muted">ends <%= reservation.endLabel %></span>
                  </div>
                </td>
                <td>
                  <span class="status-chip status-<%= reservation.status %>"><%= reservation.status %></span>
                </td>
                <td>
                  <form action="/admin/amenities/reservations/<%= reservation.id %>/status" method="post" class="inline-form">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                    <label class="sr-only" for="reservation-<%= reservation.id %>-status">Status</label>
                    <select id="reservation-<%= reservation.id %>-status" name="status">
                      <% reservationStatuses.forEach(function(status) { %>
                        <option value="<%= status %>" <%= reservation.status === status ? 'selected' : '' %>><%= status %></option>
                      <% }) %>
                    </select>
                    <button type="submit" class="pill-link secondary">Update</button>
                  </form>
                </td>
              </tr>
            <% }) %>
          </tbody>
        </table>
      </div>
    </section>

    <section class="admin-panel amenity-roster-panel">
      <h2>Amenity roster</h2>
      <ul class="amenity-roster">
        <% amenities.forEach(function(amenity) { %>
          <li>
            <div class="amenity-roster__primary">
              <h3><%= amenity.name %></h3>
              <p class="muted"><%= amenity.category %> • <%= amenity.location %></p>
            </div>
            <div class="amenity-roster__meta">
              <span><%= amenity.hours %></span>
              <% if (amenity.capacity) { %>
                <span>Capacity <%= amenity.capacity %></span>
              <% } %>
              <% if (amenity.cta) { %>
                <span><%= amenity.cta %></span>
              <% } %>
            </div>
          </li>
        <% }) %>
      </ul>
    </section>

    <section class="admin-panel admin-panel--dining" data-dining-console>
      <div class="dining-console__header">
        <div>
          <h2>Dining command console</h2>
          <p>Balance Supper Club seats, orchestrate coverage, and simulate rush moments in one control surface.</p>
        </div>
        <div class="dining-console__metrics">
          <div class="console-metric">
            <span class="console-label">Tables visible</span>
            <strong data-seat-count><%= diningSeats.length %> / <%= diningSeats.length %></strong>
          </div>
          <ul class="console-status" data-seat-summary>
            <% diningSeatSummary.forEach(function(item) { %>
              <% const statusLabel = item.status.charAt(0).toUpperCase() + item.status.slice(1); %>
              <li class="status-chip status-<%= item.status %>">
                <span class="status-label"><%= statusLabel %></span>
                <strong data-status-count="<%= item.status %>"><%= item.count %></strong>
              </li>
            <% }) %>
          </ul>
        </div>
      </div>
      <div class="dining-console__controls">
        <div class="control-group">
          <span class="control-label">Seat status</span>
          <div class="control-actions">
            <button type="button" class="pill-link secondary is-active" data-seat-filter="all" aria-pressed="true">All</button>
            <button type="button" class="pill-link secondary" data-seat-filter="available" aria-pressed="false">Available</button>
            <button type="button" class="pill-link secondary" data-seat-filter="held" aria-pressed="false">Held</button>
            <button type="button" class="pill-link secondary" data-seat-filter="reserved" aria-pressed="false">Reserved</button>
          </div>
        </div>
        <div class="control-group">
          <label class="switch">
            <input type="checkbox" data-seat-cluster>
            <span>Cluster seats by zone</span>
          </label>
        </div>
        <div class="control-group control-group--actions">
          <button type="button" class="btn btn-outline" data-seat-refresh>Reset snapshot</button>
          <button type="button" class="btn btn-outline" data-seat-randomize>Simulate rush</button>
        </div>
      </div>
      <div class="dining-console__grid">
        <div class="seat-board" data-seat-board>
          <% diningSeats.forEach(function(seat) { %>
            <% const seatStatus = (seat.status || 'available').toLowerCase(); %>
            <button
              type="button"
              class="seat-chip status-<%= seatStatus %>"
              data-seat-id="<%= seat.id %>"
              data-seat-label="<%= seat.label %>"
              data-seat-status="<%= seatStatus %>"
              data-seat-zone="<%= seat.zone %>"
              data-seat-capacity="<%= seat.capacity %>"
            >
              <span class="seat-chip__label"><%= seat.label %></span>
              <span class="seat-chip__meta"><%= seat.capacity %> guests • <%= seat.zone %></span>
            </button>
          <% }) %>
        </div>
        <div class="coverage-panel">
          <header>
            <h3>Shift coverage</h3>
            <p>Toggle visibility by role and pulse key hosts before the next seating.</p>
          </header>
          <ul class="coverage-summary">
            <% diningCoverage.forEach(function(item) { %>
              <li>
                <span><%= item.role %></span>
                <span class="count"><%= item.count %></span>
                <label class="switch">
                  <input type="checkbox" data-role-toggle value="<%= item.role %>" checked>
                  <span>Display</span>
                </label>
              </li>
            <% }) %>
          </ul>
          <div class="coverage-roster" data-coverage-roster>
            <% diningStaff.forEach(function(member) { %>
              <article
                class="coverage-card"
                data-coverage-card
                data-role="<%= (member.role || '').toLowerCase() %>"
                data-name="<%= (member.name || '').toLowerCase() %>"
                data-shift="<%= member.nextShift %>"
              >
                <header>
                  <h4><%= member.name %></h4>
                  <span class="role"><%= member.role %></span>
                </header>
                <% if (Array.isArray(member.badges) && member.badges.length) { %>
                  <ul class="badge-list">
                    <% member.badges.forEach(function(badge) { %>
                      <li><%= badge %></li>
                    <% }) %>
                  </ul>
                <% } %>
                <div class="coverage-card__meta">
                  <span data-coverage-countdown>Shift syncing…</span>
                  <time datetime="<%= member.nextShift %>"><%= new Date(member.nextShift).toLocaleString() %></time>
                </div>
                <button type="button" class="pill-link" data-toggle-shift>Pulse focus</button>
              </article>
            <% }) %>
          </div>
        </div>
      </div>
    </section>

    <section class="admin-panel">
      <h2>
        Guest inquiries
        <span class="badge" data-inquiry-badge data-open-count="<%= openInquiriesCount %>">
          <span data-inquiry-count><%= openInquiriesCount %></span> open
        </span>
      </h2>
      <ul class="inquiry-list" data-inquiry-list>
        <% if (!inquiries.length) { %>
          <li class="timeline-empty" data-empty>No inquiries received yet.</li>
        <% } %>
        <% inquiries.forEach(function(inquiry) { %>
          <li
            class="inquiry-card <%= inquiry.status === 'resolved' ? 'is-resolved' : '' %>"
            data-inquiry-id="<%= inquiry.id %>"
          >
            <header class="inquiry-header">
              <div class="stacked">
                <strong><%= inquiry.name %></strong>
                <span class="muted"><%= inquiry.email %></span>
              </div>
              <span class="status-chip status-<%= inquiry.status %>"><%= inquiry.status %></span>
            </header>
            <p><%= inquiry.message %></p>
            <footer class="inquiry-footer">
              <small class="muted">
                Received <%= new Date(inquiry.receivedAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                <% if (inquiry.status === 'resolved' && inquiry.resolvedAt) { %>
                  • Resolved <%= new Date(inquiry.resolvedAt).toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }) %>
                <% } %>
              </small>
              <form action="/admin/inquiries/<%= inquiry.id %>/status" method="post" class="inline-form">
                <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                <input type="hidden" name="status" value="<%= inquiry.status === 'resolved' ? 'open' : 'resolved' %>" />
                <button type="submit" class="pill-link <%= inquiry.status === 'resolved' ? 'secondary' : 'primary' %>">
                  <%= inquiry.status === 'resolved' ? 'Reopen' : 'Mark resolved' %>
                </button>
              </form>
            </footer>
          </li>
        <% }) %>
      </ul>
    </section>
  </div>
</section>

<script defer src="/js/admin.js"></script>
<%- include('../partials/footer') %>
