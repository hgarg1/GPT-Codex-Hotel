<%- include('../partials/head', { pageTitle, hotelName, csrfToken, darkMode }) %>
<%- include('../partials/nav') %>
<%- include('../partials/alerts') %>

<section class="dashboard" data-animate="fade-up">
  <header class="dashboard-intro">
    <h1>Welcome, <%= currentUser.name %></h1>
    <p>Monitor bookings, manage amenity reservations, and tune your profile from the Skyhaven control centre.</p>
  </header>
  <div class="dashboard-grid">
    <section class="dashboard-panel">
      <h2>Your bookings</h2>
      <% if (!bookings.length) { %>
        <p>You have no active bookings yet. Explore our <a href="/rooms">futuristic suites</a> to begin.</p>
      <% } else { %>
        <ul class="booking-collection">
          <% bookings.forEach(function(booking) { %>
            <% const checkInDate = new Date(booking.checkIn); %>
            <% const checkOutDate = new Date(booking.checkOut); %>
            <% const stayStartLabel = checkInDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); %>
            <% const stayEndLabel = checkOutDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }); %>
            <% const paymentLabel = booking.payment
              ? `${booking.payment.status.charAt(0).toUpperCase() + booking.payment.status.slice(1)} • ****${booking.payment.last4}`
              : 'No payment on file'; %>
            <li class="booking-card">
              <div class="booking-card__header">
                <div class="stacked">
                  <h3><%= booking.roomName %></h3>
                  <span class="muted">Reference <%= booking.id.slice(0, 8) %></span>
                </div>
                <span class="status-chip status-<%= booking.status.toLowerCase() %>"><%= booking.status %></span>
              </div>
              <p class="booking-card__dates"><%= stayStartLabel %> → <%= stayEndLabel %></p>
              <div class="booking-card__summary">
                <div>
                  <span class="summary-label">Guests</span>
                  <span class="summary-value"><%= booking.guests %></span>
                </div>
                <div>
                  <span class="summary-label">Total</span>
                  <span class="summary-value">$<%= booking.total.toFixed(2) %></span>
                </div>
                <div>
                  <span class="summary-label">Payment</span>
                  <span class="summary-value"><%= paymentLabel %></span>
                </div>
              </div>
              <div class="booking-card__actions">
                <% if (booking.status === 'PendingPayment') { %>
                  <a class="pill-link primary" href="/pay/<%= booking.id %>">Complete payment</a>
                <% } %>
                <% if (booking.status === 'Paid') { %>
                  <a class="pill-link" href="/invoices/<%= booking.id %>">Invoice</a>
                <% } %>
                <% if (booking.status !== 'Canceled') { %>
                  <form action="/bookings/<%= booking.id %>/cancel" method="post" class="booking-card__inline-form">
                    <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
                    <button type="submit" class="pill-link">Cancel</button>
                  </form>
                <% } %>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </section>

    <section class="dashboard-panel">
      <h2>Amenity reservations</h2>
      <% if (!reservations.length) { %>
        <p>No amenity reservations yet. Explore the <a href="/amenities">Skyhaven offerings</a>.</p>
      <% } else { %>
        <ul class="reservation-collection">
          <% reservations.forEach(function(reservation) { %>
            <% const start = new Date(reservation.timeslotStart); %>
            <% const end = new Date(reservation.timeslotEnd); %>
            <% const startLabel = start.toLocaleString('en-US', { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' }); %>
            <% const endLabel = end.toLocaleString('en-US', { hour: '2-digit', minute: '2-digit' }); %>
            <% const durationMinutes = Math.max(0, Math.round((end - start) / 60000)); %>
            <% const durationHours = Math.floor(durationMinutes / 60); %>
            <% const durationRemainder = durationMinutes % 60; %>
            <% const durationLabel = durationHours
              ? `${durationHours}h${durationRemainder ? ' ' + durationRemainder + 'm' : ''}`
              : `${durationMinutes}m`; %>
            <% const bookedLabel = new Date(reservation.createdAt).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); %>
            <li class="reservation-card">
              <div class="reservation-card__header">
                <h3><%= reservation.amenityName %></h3>
                <span class="status-chip status-<%= reservation.status %>"><%= reservation.status %></span>
              </div>
              <p class="reservation-card__window"><%= startLabel %> → <%= endLabel %></p>
              <div class="reservation-card__meta">
                <span>Duration <%= durationLabel %></span>
                <span>Booked <%= bookedLabel %></span>
              </div>
            </li>
          <% }) %>
        </ul>
      <% } %>
    </section>

    <section class="dashboard-panel">
      <h2>Profile</h2>
      <form action="/me" method="post" class="profile-form">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <label for="profile-name">Name</label>
        <input type="text" id="profile-name" name="name" value="<%= currentUser.name %>" required />
        <label for="profile-bio">Bio</label>
        <textarea id="profile-bio" name="bio" rows="4"><%= currentUser.bio || '' %></textarea>
        <label for="profile-phone">Contact</label>
        <input type="text" id="profile-phone" name="phone" value="<%= currentUser.phone || '' %>" />
        <button type="submit" class="cta-button primary">Update profile</button>
      </form>
    </section>

    <section class="dashboard-panel">
      <h2>Security</h2>
      <form action="/me/password" method="post" class="profile-form">
        <input type="hidden" name="_csrf" value="<%= csrfToken %>" />
        <label for="current-password">Current password</label>
        <input type="password" id="current-password" name="currentPassword" required />
        <div class="password-field" data-password-container data-enforce>
          <label for="new-password">New password</label>
          <input
            type="password"
            id="new-password"
            name="newPassword"
            required
            aria-describedby="dashboard-password-guidance"
            data-password-input
          />
          <div class="password-meter">
            <div class="password-meter__track">
              <div class="password-meter__bar" data-password-bar></div>
            </div>
            <p class="password-meter__label" role="status" aria-live="polite">
              Strength:
              <span data-password-strength>Start typing</span>
            </p>
          </div>
          <ul class="password-criteria" id="dashboard-password-guidance">
            <li data-password-criterion="length">
              <span class="password-criteria__icon" aria-hidden="true"></span>
              <span>At least 8 characters</span>
            </li>
            <li data-password-criterion="lowercase">
              <span class="password-criteria__icon" aria-hidden="true"></span>
              <span>Contains a lowercase letter</span>
            </li>
            <li data-password-criterion="uppercase">
              <span class="password-criteria__icon" aria-hidden="true"></span>
              <span>Contains an uppercase letter</span>
            </li>
            <li data-password-criterion="number">
              <span class="password-criteria__icon" aria-hidden="true"></span>
              <span>Contains a number</span>
            </li>
            <li data-password-criterion="special">
              <span class="password-criteria__icon" aria-hidden="true"></span>
              <span>Includes a special character</span>
            </li>
          </ul>
        </div>
        <button type="submit" class="cta-button" data-password-submit>Update password</button>
      </form>
      <p class="small-print">Sessions auto-expire after 2 hours of inactivity or 12 hours absolute time. Log out from other devices via live chat.</p>
    </section>
  </div>
</section>

<%- include('../partials/footer') %>
